# PDF æ™ºèƒ½é˜…è¯»å™¨è®¾è®¡æ–‡æ¡£

> ç›®æ ‡ï¼šå®ç°ç±»ä¼¼è±†åŒ…æµè§ˆå™¨çš„ PDF é˜…è¯»ä½“éªŒï¼Œæ”¯æŒå…ƒç´ çº§äº¤äº’å’Œ AI å¯¹è¯
> 
> æ›´æ–°æ—¶é—´ï¼š2025-12-01

## ä¸€ã€æ ¸å¿ƒåŠŸèƒ½

### 1.1 å…ƒç´ çº§äº¤äº’ï¼ˆæ ¸å¿ƒäº®ç‚¹ï¼‰

åƒå‰ç«¯ DevTools ä¸€æ ·ï¼Œç”¨æˆ·å¯ä»¥ï¼š
- **æ‚¬åœé«˜äº®** - é¼ æ ‡ç§»åˆ°å›¾è¡¨/è¡¨æ ¼/å…¬å¼ä¸Šè‡ªåŠ¨é«˜äº®
- **ç‚¹å‡»é€‰æ‹©** - ç‚¹å‡»å…ƒç´ æ·»åŠ åˆ°å³ä¾§å¼•ç”¨æ 
- **AI å¯¹è¯** - åŸºäºé€‰ä¸­å…ƒç´ ä¸ AI è®¨è®º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PDF æŸ¥çœ‹å™¨         â”‚     AI ä¾§æ       â”‚
â”‚                        â”‚                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   ğŸ“ å¼•ç”¨åˆ—è¡¨    â”‚
â”‚   â”‚   ğŸ“Š å›¾è¡¨    â”‚â†æ‚¬åœ â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   (é«˜äº®è¾¹æ¡†)  â”‚  é«˜äº®â”‚   â”‚ ğŸ“Š å›¾1   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚ ğŸ“‹ è¡¨2   â”‚  â”‚
â”‚                        â”‚   â”‚ ğŸ“ å…¬å¼3  â”‚  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚   â”‚   ğŸ“‹ è¡¨æ ¼    â”‚     â”‚                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   ğŸ’¬ å¯¹è¯åŒºåŸŸ    â”‚
â”‚                        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   E = mcÂ²  â† å…¬å¼      â”‚   â”‚ åˆ†æå›¾1  â”‚  â”‚
â”‚                        â”‚   â”‚ ä¸­çš„è¶‹åŠ¿ â”‚  â”‚
â”‚                        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 åŸºç¡€ PDF åŠŸèƒ½

- æ‰“å¼€/æ¸²æŸ“ PDF
- ç¿»é¡µå¯¼èˆª
- ç¼©æ”¾æ§åˆ¶
- æ–‡æœ¬æœç´¢
- ç›®å½•/å¤§çº²
- ç¼©ç•¥å›¾ä¾§è¾¹æ 

### 1.3 ä½¿ç”¨åœºæ™¯åŒºåˆ†

| åœºæ™¯ | PDF ç±»å‹ | éœ€è¦æ™ºèƒ½è§£æï¼Ÿ |
|------|---------|---------------|
| é˜…è¯»æ–‡çŒ® | å­¦æœ¯è®ºæ–‡ï¼ˆ< 50é¡µï¼‰ | âœ… éœ€è¦ï¼ˆå›¾è¡¨ã€å…¬å¼å¤šï¼‰ |
| é˜…è¯»ä¹¦ç± | ç”µå­ä¹¦ï¼ˆ300+ é¡µï¼‰ | âŒ ä¸éœ€è¦ï¼ˆçº¯æ–‡å­—ä¸ºä¸»ï¼‰ |
| æŸ¥çœ‹æ–‡æ¡£ | æŠ€æœ¯æ–‡æ¡£ã€æ‰‹å†Œ | ğŸ”¶ å¯é€‰ |

**ç­–ç•¥**ï¼šæŒ‰éœ€è§£æï¼Œç”¨æˆ·ä¸»åŠ¨è§¦å‘æ™ºèƒ½æ¨¡å¼ï¼Œè€Œéè‡ªåŠ¨è§£ææ‰€æœ‰ PDFã€‚

---

## äºŒã€æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”

### 2.1 æ–¹æ¡ˆå¯¹æ¯”æ€»è§ˆ

| ç‰¹æ€§ | DeepSeek-OCR | PP-Structure | MinerU |
|------|-------------|--------------|--------|
| **æ¨èåº¦** | â­â­â­ é¦–é€‰ | â­â­ è½»é‡å¤‡é€‰ | â­ åŠŸèƒ½å…¨ä½†é‡ |
| æ¨¡å‹æ¶æ„ | å•æ¨¡å‹ç«¯åˆ°ç«¯ | å¤šæ¨¡å‹ç»„åˆ | å¤šæ¨¡å‹ç»„åˆ |
| å‚æ•°é‡ | **3B** | - | - |
| æ¨¡å‹å¤§å° | ~6GB (FP16) | ~500MB | ~1-2GB |
| bbox åæ ‡ | âœ… (grounding) | âœ… | âœ… |
| è¡¨æ ¼è¯†åˆ« | âœ… | âœ… | âœ… |
| å…¬å¼è¯†åˆ« | âœ… LaTeX | âœ… | âœ… |
| å›¾ç‰‡å®šä½ | âœ… | âœ… | âœ… |
| ç†è§£èƒ½åŠ› | **å¼º**ï¼ˆVLMï¼‰ | ä¸­ | ä¸­ |
| æ˜¾å­˜è¦æ±‚ | 8GB+ | 2-4GB | 4-8GB |
| CPU å¯ç”¨ | å¯è¡Œä½†æ…¢ | âœ… | å¯è¡Œ |
| éƒ¨ç½²éš¾åº¦ | ç®€å• | ç®€å• | ä¸­ç­‰ |

### 2.2 é¦–é€‰æ–¹æ¡ˆï¼šDeepSeek-OCR

[DeepSeek-OCR](https://github.com/deepseek-ai/DeepSeek-OCR) æ˜¯æ·±åº¦æ±‚ç´¢æ¨å‡ºçš„è§†è§‰è¯­è¨€æ¨¡å‹ï¼Œä¸“æ³¨äº OCR ä¸"ä¸Šä¸‹æ–‡å…‰å­¦å‹ç¼©"ã€‚

#### æ ¸å¿ƒä¼˜åŠ¿

1. **å•æ¨¡å‹ç«¯åˆ°ç«¯** - ä¸éœ€è¦å¤šä¸ªæ¨¡å‹é…åˆ
2. **æ”¯æŒ Grounding** - è¾“å‡ºå…ƒç´ çš„ bbox åæ ‡
3. **3B å‚æ•°** - å¤§å°é€‚ä¸­ï¼Œæ¶ˆè´¹çº§æ˜¾å¡å¯è·‘
4. **ç†è§£èƒ½åŠ›å¼º** - VLM æ¶æ„ï¼Œä¸åªæ˜¯ OCR
5. **å®˜æ–¹æ”¯æŒ vLLM** - é«˜æ•ˆæ¨ç†

#### Prompt æ¨¡å¼

```python
# æ–‡æ¡£è½¬ Markdown + bbox å®šä½ âœ… æ¨è
"<image>\n<|grounding|>Convert the document to markdown."

# å›¾ç‰‡ OCR + å®šä½
"<image>\n<|grounding|>OCR this image."

# çº¯ OCRï¼ˆæ— å¸ƒå±€ä¿¡æ¯ï¼‰
"<image>\nFree OCR."

# è§£æå›¾è¡¨
"<image>\nParse the figure."

# å®šä½ç‰¹å®šæ–‡æœ¬ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰
"<image>\nLocate <|ref|>å…ˆå¤©ä¸‹ä¹‹å¿§è€Œå¿§<|/ref|> in the image."
```

#### åˆ†è¾¨ç‡æ”¯æŒ

| æ¨¡å¼ | åˆ†è¾¨ç‡ | Vision Tokens | é€‚ç”¨åœºæ™¯ |
|------|--------|---------------|---------|
| Tiny | 512Ã—512 | 64 | å¿«é€Ÿé¢„è§ˆ |
| Small | 640Ã—640 | 100 | ä¸€èˆ¬æ–‡æ¡£ |
| Base | 1024Ã—1024 | 256 | é«˜æ¸…æ–‡æ¡£ |
| Large | 1280Ã—1280 | 400 | å¤æ‚å›¾è¡¨ |
| Dynamic | nÃ—640 + 1024 | åŠ¨æ€ | é•¿æ–‡æ¡£ |

#### ç¡¬ä»¶è¦æ±‚

```
æ¨èé…ç½®ï¼š
â”œâ”€â”€ GPU: RTX 4070+ (12GB+)
â”œâ”€â”€ RAM: 16GB+
â””â”€â”€ é€Ÿåº¦: A100-40G çº¦ 2500 tokens/s

æœ€ä½é…ç½®ï¼ˆé‡åŒ–åï¼‰ï¼š
â”œâ”€â”€ GPU: RTX 3060 (8GB) - INT8 é‡åŒ–
â”œâ”€â”€ æˆ– CPU: 32GB RAM - å¾ˆæ…¢ä½†å¯ç”¨
â””â”€â”€ é‡åŒ–ç‰ˆ: INT4 çº¦ 1.5GB
```

#### éƒ¨ç½²æ–¹å¼

```python
# æ–¹å¼ 1: vLLMï¼ˆé«˜æ€§èƒ½ï¼Œæ¨èï¼‰
from vllm import LLM, SamplingParams
from vllm.model_executor.models.deepseek_ocr import NGramPerReqLogitsProcessor

llm = LLM(
    model="deepseek-ai/DeepSeek-OCR",
    enable_prefix_caching=False,
)

prompt = "<image>\n<|grounding|>Convert the document to markdown."
# ... æ¨ç†ä»£ç 

# æ–¹å¼ 2: Transformersï¼ˆç®€å•ï¼‰
from transformers import AutoModel, AutoTokenizer
import torch

model = AutoModel.from_pretrained(
    "deepseek-ai/DeepSeek-OCR",
    trust_remote_code=True
).eval().cuda().to(torch.bfloat16)

prompt = "<image>\n<|grounding|>Convert the document to markdown."
res = model.infer(tokenizer, prompt=prompt, image_file=image_path)
```

### 2.3 è½»é‡å¤‡é€‰ï¼šPP-Structure

[PP-Structure](https://github.com/PaddlePaddle/PaddleOCR/tree/main/ppstructure) æ˜¯ PaddleOCR çš„æ–‡æ¡£åˆ†ææ¨¡å—ã€‚

#### é€‚ç”¨åœºæ™¯

- ç”¨æˆ·è®¾å¤‡æ²¡æœ‰ç‹¬ç«‹æ˜¾å¡
- éœ€è¦å¿«é€Ÿè½»é‡çš„è§£æ
- ä¸éœ€è¦æ·±åº¦è¯­ä¹‰ç†è§£

#### è¾“å‡ºæ ¼å¼

```json
{
  "layout": [
    {
      "type": "table",
      "bbox": [34, 303, 553, 520],
      "html": "<table>...</table>"
    },
    {
      "type": "figure", 
      "bbox": [34, 55, 552, 288]
    },
    {
      "type": "text",
      "bbox": [34, 525, 552, 580],
      "text": "å›¾1æ˜¾ç¤ºäº†..."
    }
  ]
}
```

### 2.4 å…¶ä»–å‚è€ƒé¡¹ç›®

| é¡¹ç›® | ç‰¹ç‚¹ | æ˜¯å¦è€ƒè™‘ |
|------|------|---------|
| MinerU | åŠŸèƒ½å…¨ï¼Œå¤šæ¨¡å‹ç»„åˆ | ä½œä¸ºå‚è€ƒ |
| GOT-OCR | ç«¯åˆ°ç«¯ OCR | å¾…è¯„ä¼° |
| Nougat | Meta å‡ºå“ï¼Œå­¦æœ¯ PDF è½¬ LaTeX | ç‰¹å®šåœºæ™¯ |

### 2.5 æ¨èç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤šåç«¯æ™ºèƒ½é€‰æ‹©                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   ç”¨æˆ·æ‰“å¼€ PDF                                              â”‚
â”‚        â†“                                                    â”‚
â”‚   è¯¢é—®ï¼š"å¯ç”¨æ™ºèƒ½é˜…è¯»æ¨¡å¼ï¼Ÿ"                                 â”‚
â”‚        â†“                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  é€‰æ‹©è§£æåç«¯ï¼š                                      â”‚  â”‚
â”‚   â”‚                                                     â”‚  â”‚
â”‚   â”‚  ğŸš€ DeepSeek-OCRï¼ˆæ¨èï¼‰                            â”‚  â”‚
â”‚   â”‚     - éœ€è¦ GPU 8GB+                                 â”‚  â”‚
â”‚   â”‚     - é¦–æ¬¡éœ€ä¸‹è½½æ¨¡å‹ (~6GB)                         â”‚  â”‚
â”‚   â”‚                                                     â”‚  â”‚
â”‚   â”‚  âš¡ PP-Structureï¼ˆè½»é‡ï¼‰                            â”‚  â”‚
â”‚   â”‚     - CPU å¯è¿è¡Œ                                    â”‚  â”‚
â”‚   â”‚     - æ¨¡å‹è¾ƒå° (~500MB)                             â”‚  â”‚
â”‚   â”‚                                                     â”‚  â”‚
â”‚   â”‚  â˜ï¸ äº‘ç«¯ API                                        â”‚  â”‚
â”‚   â”‚     - æ— éœ€æœ¬åœ°æ¨¡å‹                                   â”‚  â”‚
â”‚   â”‚     - éœ€è¦è”ç½‘                                       â”‚  â”‚
â”‚   â”‚                                                     â”‚  â”‚
â”‚   â”‚  ğŸ“¦ è·³è¿‡ï¼ˆä»…åŸºç¡€é˜…è¯»ï¼‰                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€å‰ç«¯ç»„ä»¶è®¾è®¡

### 3.1 ç»„ä»¶ç»“æ„

```
src/components/pdf/
â”œâ”€â”€ PDFViewer.tsx          # ä¸»ç»„ä»¶
â”œâ”€â”€ PDFCanvas.tsx          # PDF æ¸²æŸ“å±‚ (react-pdf)
â”œâ”€â”€ InteractiveLayer.tsx   # äº¤äº’è¦†ç›–å±‚
â”œâ”€â”€ ElementOverlay.tsx     # å•ä¸ªå…ƒç´ è¦†ç›–
â”œâ”€â”€ PDFToolbar.tsx         # å·¥å…·æ ï¼ˆç¿»é¡µã€ç¼©æ”¾ç­‰ï¼‰
â”œâ”€â”€ PDFOutline.tsx         # ç›®å½•å¤§çº²
â”œâ”€â”€ PDFThumbnails.tsx      # ç¼©ç•¥å›¾ä¾§è¾¹æ 
â”œâ”€â”€ ReferenceSidebar.tsx   # å¼•ç”¨ + AI å¯¹è¯ä¾§è¾¹æ 
â””â”€â”€ hooks/
    â”œâ”€â”€ usePDFDocument.ts  # PDF æ–‡æ¡£çŠ¶æ€
    â”œâ”€â”€ usePDFStructure.ts # ç»“æ„åŒ–æ•°æ®
    â””â”€â”€ useElementSelection.ts # å…ƒç´ é€‰æ‹©
```

### 3.2 æ ¸å¿ƒç»„ä»¶

#### PDFViewer.tsx

```tsx
interface PDFViewerProps {
  filePath: string;
  onElementSelect?: (element: PDFElement) => void;
}

function PDFViewer({ filePath, onElementSelect }: PDFViewerProps) {
  const { document, loading } = usePDFDocument(filePath);
  const { structure, parsing } = usePDFStructure(filePath);
  const [currentPage, setCurrentPage] = useState(1);
  const [scale, setScale] = useState(1);
  const [selectedElements, setSelectedElements] = useState<PDFElement[]>([]);

  return (
    <div className="pdf-viewer">
      <PDFToolbar 
        currentPage={currentPage}
        totalPages={document?.numPages}
        scale={scale}
        onPageChange={setCurrentPage}
        onScaleChange={setScale}
      />
      
      <div className="pdf-content">
        <PDFThumbnails 
          document={document}
          currentPage={currentPage}
          onPageClick={setCurrentPage}
        />
        
        <div className="pdf-main">
          <PDFCanvas 
            document={document}
            page={currentPage}
            scale={scale}
          />
          
          {structure && (
            <InteractiveLayer
              pageStructure={structure.pages[currentPage - 1]}
              scale={scale}
              onElementClick={(el) => {
                setSelectedElements([...selectedElements, el]);
                onElementSelect?.(el);
              }}
            />
          )}
        </div>
        
        <ReferenceSidebar 
          elements={selectedElements}
          onRemove={(el) => setSelectedElements(
            selectedElements.filter(e => e !== el)
          )}
        />
      </div>
    </div>
  );
}
```

#### InteractiveLayer.tsx

```tsx
interface InteractiveLayerProps {
  pageStructure: PageStructure;
  scale: number;
  onElementClick: (element: PDFElement) => void;
}

function InteractiveLayer({ pageStructure, scale, onElementClick }: InteractiveLayerProps) {
  const [hoveredElement, setHoveredElement] = useState<PDFElement | null>(null);

  return (
    <div className="interactive-layer absolute inset-0 pointer-events-none">
      {pageStructure.blocks
        .filter(block => ['image', 'table', 'equation'].includes(block.type))
        .map((block, index) => (
          <ElementOverlay
            key={index}
            element={block}
            scale={scale}
            isHovered={hoveredElement === block}
            onMouseEnter={() => setHoveredElement(block)}
            onMouseLeave={() => setHoveredElement(null)}
            onClick={() => onElementClick(block)}
          />
        ))}
    </div>
  );
}
```

#### ElementOverlay.tsx

```tsx
interface ElementOverlayProps {
  element: PDFElement;
  scale: number;
  isHovered: boolean;
  onMouseEnter: () => void;
  onMouseLeave: () => void;
  onClick: () => void;
}

function ElementOverlay({ element, scale, isHovered, ...handlers }: ElementOverlayProps) {
  const [x, y, x2, y2] = element.bbox;
  
  const style: CSSProperties = {
    position: 'absolute',
    left: x * scale,
    top: y * scale,
    width: (x2 - x) * scale,
    height: (y2 - y) * scale,
    border: isHovered ? '2px solid #3b82f6' : '2px solid transparent',
    backgroundColor: isHovered ? 'rgba(59, 130, 246, 0.1)' : 'transparent',
    cursor: 'pointer',
    pointerEvents: 'auto',
    transition: 'all 0.15s ease',
  };

  const iconMap = {
    image: 'ğŸ“Š',
    table: 'ğŸ“‹',
    equation: 'ğŸ“',
  };

  return (
    <div style={style} {...handlers}>
      {isHovered && (
        <div className="absolute -top-6 left-0 bg-blue-500 text-white text-xs px-2 py-1 rounded">
          {iconMap[element.type]} ç‚¹å‡»æ·»åŠ åˆ°å¼•ç”¨
        </div>
      )}
    </div>
  );
}
```

---

## å››ã€æ•°æ®æµè®¾è®¡

### 4.1 çŠ¶æ€ç®¡ç†

```typescript
// stores/usePDFStore.ts
interface PDFState {
  // å½“å‰æ‰“å¼€çš„ PDF
  currentFile: string | null;
  
  // è§£æçŠ¶æ€
  parseStatus: 'idle' | 'parsing' | 'done' | 'error';
  
  // ç»“æ„åŒ–æ•°æ®
  structure: PDFStructure | null;
  
  // é€‰ä¸­çš„å…ƒç´ å¼•ç”¨
  selectedElements: PDFElement[];
  
  // åŠ¨ä½œ
  openPDF: (path: string) => Promise<void>;
  closePDF: () => void;
  addElement: (element: PDFElement) => void;
  removeElement: (element: PDFElement) => void;
  clearElements: () => void;
}
```

### 4.2 PDF å…ƒç´ ç±»å‹

```typescript
interface PDFElement {
  type: 'text' | 'image' | 'table' | 'equation';
  bbox: [number, number, number, number]; // [x1, y1, x2, y2]
  pageIndex: number;
  
  // å†…å®¹ï¼ˆæ ¹æ®ç±»å‹ä¸åŒï¼‰
  content?: string;      // æ–‡æœ¬/Markdown
  latex?: string;        // å…¬å¼çš„ LaTeX
  imagePath?: string;    // å›¾ç‰‡è·¯å¾„
  caption?: string;      // å›¾/è¡¨æ ‡é¢˜
}

interface PageStructure {
  pageIndex: number;
  width: number;
  height: number;
  blocks: PDFElement[];
}

interface PDFStructure {
  pageCount: number;
  pages: PageStructure[];
}
```

---

## äº”ã€AI é›†æˆ

### 5.1 å¼•ç”¨å‘é€ç»™ AI

å½“ç”¨æˆ·é€‰ä¸­å…ƒç´ åï¼Œå¯ä»¥åœ¨å¯¹è¯ä¸­å¼•ç”¨ï¼š

```typescript
interface AIMessage {
  role: 'user' | 'assistant';
  content: string;
  
  // PDF å¼•ç”¨
  references?: PDFElement[];
}

// æ„å»ºå¸¦å¼•ç”¨çš„æç¤ºè¯
function buildPromptWithReferences(
  userMessage: string, 
  references: PDFElement[]
): string {
  let prompt = userMessage;
  
  if (references.length > 0) {
    prompt += '\n\n---\nå¼•ç”¨çš„å†…å®¹ï¼š\n';
    
    for (const ref of references) {
      switch (ref.type) {
        case 'image':
          prompt += `\n[å›¾ç‰‡: ${ref.caption || 'æœªå‘½å'}]\n`;
          // å›¾ç‰‡éœ€è¦ç”¨å¤šæ¨¡æ€ API
          break;
        case 'table':
          prompt += `\n[è¡¨æ ¼]\n${ref.content}\n`;
          break;
        case 'equation':
          prompt += `\n[å…¬å¼] $${ref.latex}$\n`;
          break;
        case 'text':
          prompt += `\n[æ–‡æœ¬] ${ref.content}\n`;
          break;
      }
    }
  }
  
  return prompt;
}
```

### 5.2 å¤šæ¨¡æ€æ”¯æŒ

å¯¹äºå›¾ç‰‡ç±»å‹çš„å¼•ç”¨ï¼Œéœ€è¦ä½¿ç”¨æ”¯æŒè§†è§‰çš„æ¨¡å‹ï¼š

```typescript
// å¦‚æœå¼•ç”¨ä¸­åŒ…å«å›¾ç‰‡ï¼Œä½¿ç”¨å¤šæ¨¡æ€ API
async function sendToAI(message: string, references: PDFElement[]) {
  const hasImages = references.some(r => r.type === 'image');
  
  if (hasImages) {
    // ä½¿ç”¨ GPT-4V / Claude Vision
    const imageRefs = references.filter(r => r.type === 'image');
    const images = await Promise.all(
      imageRefs.map(r => readImageAsBase64(r.imagePath))
    );
    
    return callMultimodalAPI(message, images);
  } else {
    // ä½¿ç”¨æ™®é€šæ–‡æœ¬ API
    return callTextAPI(buildPromptWithReferences(message, references));
  }
}
```

---

## å…­ã€ç¼“å­˜ç­–ç•¥

### 6.1 è§£æç»“æœç¼“å­˜

```
PDF ç¼“å­˜ç›®å½•ç»“æ„ï¼š
~/.lumina-note/pdf-cache/
â”œâ”€â”€ {pdf-hash}/
â”‚   â”œâ”€â”€ structure.json     # ç»“æ„åŒ–æ•°æ®
â”‚   â”œâ”€â”€ images/            # æå–çš„å›¾ç‰‡
â”‚   â”‚   â”œâ”€â”€ page_0_img_0.png
â”‚   â”‚   â”œâ”€â”€ page_0_img_1.png
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ metadata.json      # ç¼“å­˜å…ƒæ•°æ®ï¼ˆæ—¶é—´ã€ç‰ˆæœ¬ç­‰ï¼‰
```

### 6.2 ç¼“å­˜ç­–ç•¥

```rust
fn get_cached_structure(pdf_path: &str) -> Option<PDFStructure> {
    let pdf_hash = calculate_file_hash(pdf_path);
    let cache_dir = get_cache_dir(&pdf_hash);
    let structure_path = cache_dir.join("structure.json");
    
    if structure_path.exists() {
        // æ£€æŸ¥ PDF æ˜¯å¦è¢«ä¿®æ”¹
        let metadata = read_metadata(&cache_dir)?;
        let pdf_mtime = get_file_mtime(pdf_path)?;
        
        if metadata.pdf_mtime == pdf_mtime {
            // ç¼“å­˜æœ‰æ•ˆ
            return Some(read_structure(&structure_path)?);
        }
    }
    
    None // éœ€è¦é‡æ–°è§£æ
}
```

---

## ä¸ƒã€å¼€å‘è®¡åˆ’

### Phase 1ï¼šåŸºç¡€ PDF æŸ¥çœ‹å™¨ï¼ˆ1-2 å¤©ï¼‰

- [ ] é›†æˆ react-pdf
- [ ] å®ç°åŸºç¡€æ¸²æŸ“
- [ ] ç¿»é¡µ/ç¼©æ”¾æ§åˆ¶
- [ ] æ–‡æœ¬é€‰æ‹©/æœç´¢

### Phase 2ï¼šMinerU é›†æˆï¼ˆ2-3 å¤©ï¼‰

- [ ] Rust åç«¯è°ƒç”¨ MinerU
- [ ] è§£æç»“æœç¼“å­˜
- [ ] ç»“æ„åŒ–æ•°æ®æ¥å£

### Phase 3ï¼šäº¤äº’å±‚å®ç°ï¼ˆ2-3 å¤©ï¼‰

- [ ] å…ƒç´ è¦†ç›–å±‚æ¸²æŸ“
- [ ] æ‚¬åœé«˜äº®æ•ˆæœ
- [ ] ç‚¹å‡»é€‰æ‹©åŠŸèƒ½
- [ ] å…ƒç´ ç±»å‹å›¾æ ‡

### Phase 4ï¼šå¼•ç”¨ä¾§è¾¹æ ï¼ˆ1-2 å¤©ï¼‰

- [ ] å¼•ç”¨åˆ—è¡¨ UI
- [ ] å…ƒç´ é¢„è§ˆå¡ç‰‡
- [ ] åˆ é™¤/æ¸…ç©ºå¼•ç”¨

### Phase 5ï¼šAI å¯¹è¯é›†æˆï¼ˆ1-2 å¤©ï¼‰

- [ ] å¸¦å¼•ç”¨çš„å¯¹è¯
- [ ] å¤šæ¨¡æ€å›¾ç‰‡æ”¯æŒ
- [ ] ä¸Šä¸‹æ–‡å…³è”

### Phase 6ï¼šé«˜çº§åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

- [ ] æ‰‹åŠ¨æ¡†é€‰åŒºåŸŸ
- [ ] PDF æ³¨é‡Š/é«˜äº®
- [ ] å¯¼å‡ºå¼•ç”¨ä¸ºç¬”è®°
- [ ] æ‰¹é‡å¤„ç†å¤šä¸ª PDF

---

## å…«ã€ä¾èµ–æ¸…å•

### å‰ç«¯

```json
{
  "react-pdf": "^7.x",
  "pdfjs-dist": "^3.x"
}
```

### åç«¯/å·¥å…·

- **MinerU**: `pip install magic-pdf[full]`
- æˆ– Docker: `opendatalab/mineru`

### ç³»ç»Ÿè¦æ±‚

- Python 3.8+ï¼ˆMinerU è¿è¡Œç¯å¢ƒï¼‰
- çº¦ 2-4GB ç£ç›˜ç©ºé—´ï¼ˆæ¨¡å‹æ–‡ä»¶ï¼‰

---

## ä¹ã€å‚è€ƒèµ„æ–™

- [MinerU GitHub](https://github.com/opendatalab/MinerU)
- [react-pdf æ–‡æ¡£](https://github.com/wojtekmaj/react-pdf)
- [pdf.js å®˜æ–¹](https://mozilla.github.io/pdf.js/)

---

## åã€å¾…è®¨è®ºé—®é¢˜

1. **MinerU éƒ¨ç½²æ–¹å¼**
   - æœ¬åœ° Python ç¯å¢ƒï¼Ÿ
   - Docker å®¹å™¨ï¼Ÿ
   - äº‘æœåŠ¡ï¼Ÿ

2. **é¦–æ¬¡è§£æä½“éªŒ**
   - MinerU è§£æè¾ƒæ…¢ï¼ˆå¤æ‚ PDF å¯èƒ½éœ€è¦å‡ åç§’ï¼‰
   - æ˜¯å¦æ˜¾ç¤ºè¿›åº¦æ¡ï¼Ÿ
   - æ˜¯å¦æ”¯æŒå–æ¶ˆï¼Ÿ

3. **ç¦»çº¿æ”¯æŒ**
   - MinerU éœ€è¦æ¨¡å‹æ–‡ä»¶
   - æ˜¯å¦æ‰“åŒ…åˆ°åº”ç”¨ä¸­ï¼Ÿ
   - è¿˜æ˜¯é¦–æ¬¡ä½¿ç”¨æ—¶ä¸‹è½½ï¼Ÿ

4. **æ¡†é€‰åŠŸèƒ½**
   - æ˜¯å¦åŒæ—¶æ”¯æŒæ‰‹åŠ¨æ¡†é€‰ï¼Ÿ
   - æ¡†é€‰åå¦‚ä½•å¤„ç†ï¼ˆæˆªå›¾ vs OCRï¼‰ï¼Ÿ

5. **ç¬”è®°é›†æˆ**
   - å¼•ç”¨çš„å…ƒç´ å¦‚ä½•åµŒå…¥åˆ° Markdown ç¬”è®°ä¸­ï¼Ÿ
   - ä½¿ç”¨ä»€ä¹ˆæ ¼å¼ä¿å­˜ï¼Ÿ
